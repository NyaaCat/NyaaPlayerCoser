language: java
jdk: oraclejdk8
before_install:
  - git config --global user.email "builds@travis-ci.com"
  - git config --global user.name "Travis CI"
  - export MAJOR_VERSION=`sed -n 's/^ext.majorVersion = \(.*\)$/\1/p' build.gradle`
  - export MINOR_VERSION=`sed -n 's/^ext.minorVersion = \(.*\)$/\1/p' build.gradle`
  - export MC_VERSION=`sed -n 's/^ext.minecraftVersion = "\(.*\)"$/\1/p' build.gradle`
  - export FULL_VERSION_STRING=$MAJOR_VERSION.$MINOR_VERSION.$TRAVIS_BUILD_NUMBER-mc$MC_VERSION
  - 'sed -i "s/^\(version: \).*\$/\1$FULL_VERSION_STRING/g" src/main/resources/plugin.yml'
  - pushd ~/build/
  - git clone --depth=1 https://github.com/NyaaCat/NyaaCore NyaaCat/NyaaCore
  - export NYAACORE_LANG_DIR=`readlink -f ./NyaaCat/NyaaCore/src/main/resources/lang/`
  - popd
  - 'php update_spigot.php'
after_success:
  - 'cp build/libs/$archivesBaseName.jar ./$archivesBaseName-$FULL_VERSION_STRING.jar'
before_deploy:
  - export GIT_TAG=v$FULL_VERSION_STRING
  - export GIT_ORIGIN_URL=`git config --get remote.origin.url`
  - git tag $GIT_TAG -a -m "Generated tag from TravisCI for build $TRAVIS_BUILD_NUMBER"
  - git config credential.helper "store --file=.git/credentials"
  - echo "https://${GITHUB_KEY}:@github.com" > .git/credentials
  - git push origin HEAD:$TRAVIS_BRANCH -q --follow-tags
deploy:
  - provider: releases
    skip_cleanup: true
    prerelease: true
    api_key: ${GITHUB_DEPLOY_KEY}
    file: './$archivesBaseName-$FULL_VERSION_STRING.jar'
    on:
      tags: false
      all_branches: true

env:
  global:
    - main_version=1
    - archivesBaseName=NyaaPlayerCoser
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -f  $HOME/.gradle/caches/*/fileHashes/fileHashes.bin
  - rm -f  $HOME/.gradle/caches/*/fileHashes/fileHashes.lock
  - rm -f  $HOME/.gradle/caches/transforms-1/transforms-1.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
  - rm -f  $HOME/.gradle/caches/*/fileContent/fileContent.lock

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/cache/
branches:
  except:
    - "/^*-mc/"